( function( factory ) {
    if( typeof define === "function" && define.amd ) {
        define( [ "@zoho/lyte-dom" ], factory );
    }
    else {
        factory( $L );
    }
} )( function( $L ){

    if($L){

        var grpArr=[],groupNo,focArr=[];
  
    $L.focusStack = function(param){

        document.addEventListener('keydown',function(event){
                focArr = document.querySelectorAll('[lyte-focus-after]');
                if(event.key=='Tab' && event.shiftKey==false){
                        let currentActiveElement=document.activeElement, nextElementNfe=currentActiveElement.getAttribute('lyte-nfocus-name'),
                        nextElementTabind=currentActiveElement.getAttribute('data-tabindex');
                        var resInd;

                        if(nextElementNfe!=null && document.querySelector(`[lyte-focus-name=${nextElementNfe}]`)!=null ){
                            event.preventDefault();
                            if(param && param.onBeforeChange && currentActiveElement.getAttribute('lyte-is-callback')&& currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true"){
                                 param.onBeforeChange();
                                }
                            document.querySelector(`[lyte-focus-name=${nextElementNfe}]`).focus();
                            if(param && param.onAfterChange && currentActiveElement.getAttribute('lyte-is-callback') && currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {
                                param.onAfterChange();}
                        }
                        else if(nextElementTabind!=null && nextElementTabind!=undefined && nextElementTabind.includes('group')){
                            if(grpArr.length==0){
                                groupNo= (currentActiveElement.getAttribute('data-tabindex').split('group')[1]);
                                groupNo=Number.parseInt( groupNo.split('-')[0]);
                                grpArr=document.querySelectorAll(`[data-tabindex^="group${groupNo}"]`);
                                grpArr=Array.from(grpArr);
                                window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
                               
                                if(curInd<grpArr.length-1){
                                    resInd = isSameIndExists( currentActiveElement, curInd );
                                    let Elem;
                                    if( resInd != -1 ){
                                        Elem = grpArr[ resInd ];
                                    }
                                    else {
                                        Elem=document.querySelector(`[data-tabindex="group${groupNo}-${curInd+1}"]`);
                                    }
                                    if(Elem){
                                        event.preventDefault();
                                        if(param && param.onBeforeChange && currentActiveElement.getAttribute('lyte-is-callback') && currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true"){ param.onBeforeChange();}
                                        Elem.focus();
                                        if(param && param.onAfterChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onAfterChange();}
                                    }
                                }
                                else if(curInd==grpArr.length-1){
                                    if(checkLoopNext()) {event.preventDefault();}
                                }
                                if( isLastOfGroup( currentActiveElement ) ){
                                    if(param && param.ltPropChangeFocus && param.ltPropChangeFocus != 'false'  ){
                                        changeFocus(groupNo);
                                    }
                                }
                            }
                            else {
                                    if((currentActiveElement.getAttribute('data-tabindex').split('group')[1]).charAt(0)==groupNo){
                                        window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
                                        if(curInd<grpArr.length-1){
                                            resInd = isSameIndExists( currentActiveElement, curInd );
                                            let Elem;
                                            if( resInd != -1 ){
                                                Elem = grpArr[ resInd ];
                                            }
                                            else {
                                                Elem=document.querySelector(`[data-tabindex="group${groupNo}-${curInd+1}"]`);
                                            }
                                            if(Elem){
                                                event.preventDefault();
                                                if(param && param.onBeforeChange &&currentActiveElement.getAttribute('lyte-is-callback')&& currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onBeforeChange();}
                                                Elem.focus();
                                                if(param && param.onAfterChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onAfterChange();}
                                            }
                 
                                        }
                                        else if(curInd==grpArr.length-1){
                                            if(checkLoopNext()) {event.preventDefault();}
                                        }

                                        if( isLastOfGroup( currentActiveElement ) ){
                                            if(param && param.ltPropChangeFocus && param.ltPropChangeFocus != 'false'  ){
                                                changeFocus(groupNo);
                                            }
                                        }
                                    }
                                    else{
                                        groupNo= (currentActiveElement.getAttribute('data-tabindex').split('group')[1]);
                                        groupNo=Number.parseInt( groupNo.split('-')[0]);
                                        grpArr=document.querySelectorAll(`[data-tabindex^="group${groupNo}"]`);
                                        grpArr=Array.from(grpArr);
                                        window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
                                        if(curInd<grpArr.length-1){
                                            resInd = isSameIndExists( currentActiveElement, curInd );
                                            let Elem;
                                            if( resInd != -1 ){
                                                Elem = grpArr[ resInd ];
                                            }
                                            else {
                                                Elem=document.querySelector(`[data-tabindex="group${groupNo}-${curInd+1}"]`);
                                            }
                                            if(Elem){
                                                event.preventDefault();
                                                if(param && param.onBeforeChange &&currentActiveElement.getAttribute('lyte-is-callback')&& currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onBeforeChange();}
                                                Elem.focus();
                                                if(param && param.onAfterChange  && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onAfterChange();}
                                            }
          
                                        }
                                        else if(curInd==grpArr.length-1){
                                            if(checkLoopNext()){ event.preventDefault();}
                                        }
                                        if( isLastOfGroup( currentActiveElement ) ){
                                            if(param && param.ltPropChangeFocus && param.ltPropChangeFocus != 'false'){
                                                changeFocus(groupNo);
                                            }
                                        }
                                    }
                            }
                           
                        }
                }
                else if(event.key=='Tab' && event.shiftKey==true){
                    let currentActiveElement=document.activeElement, prevElementNfe=currentActiveElement.getAttribute('lyte-bfocus-name'),
                        prevElementTabind=currentActiveElement.getAttribute('data-tabindex');

                        if(prevElementNfe!=null &&  document.querySelector(`[lyte-focus-name=${prevElementNfe}]`)!=null ){
                            event.preventDefault();
                            if(param && param.onBeforeChange && currentActiveElement.getAttribute('lyte-is-callback')&& currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onBeforeChange();}
                            document.querySelector(`[lyte-focus-name=${prevElementNfe}]`).focus();
                            if(param && param.onAfterChange  && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") { param.onAfterChange();}
                        }
                        else if(prevElementTabind!=null && prevElementTabind!=undefined && prevElementTabind.includes('group')){
                           
                            if(grpArr.length==0){
                                groupNo= (currentActiveElement.getAttribute('data-tabindex').split('group')[1]);
                                groupNo=Number.parseInt( groupNo.split('-')[0]);
                                grpArr=document.querySelectorAll(`[data-tabindex^="group${groupNo}"]`);
                                grpArr=Array.from(grpArr);
                                window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
                                if(curInd>=1){
                                    resInd = isSameIndExistsPrev( currentActiveElement, curInd );
                                    let Elem;
                                    if( resInd != -1 ){
                                        Elem = grpArr[ resInd ];
                                    }
                                    else {
                                        let elemArr = document.querySelectorAll(`[data-tabindex="group${groupNo}-${curInd-1}"]`);
                                        Elem = elemArr[ elemArr.length -1 ];
                                    }
                                    if(Elem){
                                        event.preventDefault();
                                        if(param && param.onBeforeChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onBeforeChange();}
                                        Elem.focus();
                                        if(param && param.onAfterChange &&currentActiveElement.getAttribute('lyte-is-callback')&& currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true"){ param.onAfterChange();}
                                    }
        
                                }
                                else if(curInd==0){
                                    if(checkLoopPrev()){
                                        event.preventDefault();
                                    }
                                }
                            }
                            else {
                                    if((currentActiveElement.getAttribute('data-tabindex').split('group')[1]).charAt(0)==groupNo){
                                        window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
                                        if(curInd>=1){
                                            resInd = isSameIndExistsPrev( currentActiveElement, curInd );
                                            let Elem;
                                            if( resInd != -1 ){
                                                Elem = grpArr[ resInd ];
                                            }
                                            else {
                                                let elemArr = document.querySelectorAll(`[data-tabindex="group${groupNo}-${curInd-1}"]`);
                                                Elem = elemArr[ elemArr.length -1 ];
                                            }
                                            if(Elem){
                                                event.preventDefault();
                                                if(param && param.onBeforeChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onBeforeChange();}
                                                Elem.focus();
                                                if(param && param.onAfterChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onAfterChange();}
                                            }
       
                                        }
                                        else if(curInd==0){
                                            if(checkLoopPrev()){
                                                event.preventDefault();
                                            }
                                        }
                                    }
                                    else{
                                        groupNo= (currentActiveElement.getAttribute('data-tabindex').split('group')[1]);
                                        groupNo=Number.parseInt( groupNo.split('-')[0]);
                                        grpArr=document.querySelectorAll(`[data-tabindex^="group${groupNo}"]`);
                                        grpArr=Array.from(grpArr);
                                        window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
                                        if(curInd>=1){
                                            resInd = isSameIndExistsPrev( currentActiveElement, curInd );
                                            let Elem;
                                            if( resInd != -1 ){
                                                Elem = grpArr[ resInd ];
                                            }
                                            else {
                                                let elemArr = document.querySelectorAll(`[data-tabindex="group${groupNo}-${curInd-1}"]`);
                                                Elem = elemArr[ elemArr.length -1 ];
                                            }
                                            if(Elem){
                                                event.preventDefault();
                                                if(param && param.onBeforeChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onBeforeChange();}
                                                Elem.focus();
                                                if(param && param.onAfterChange && currentActiveElement.getAttribute('lyte-is-callback')&&currentActiveElement.getAttribute('lyte-is-callback').toLowerCase()=="true") {param.onAfterChange();}
                                            }
     
                                        }
                                        else if(curInd==0){
                                            if(checkLoopPrev()){
                                                event.preventDefault();
                                            }
                                        }
                                    }
                                
                                
                            }
                           
                        }
                       

                }
        });
    }
    function checkLoopNext(){
        let currentActiveElement=document.activeElement;

        groupNo= (currentActiveElement.getAttribute('data-tabindex').split('group')[1]);
        groupNo=Number.parseInt( groupNo.split('-')[0]);
        grpArr=document.querySelectorAll(`[data-tabindex^="group${groupNo}"]`);
        grpArr=Array.from(grpArr);
        window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
        let nextDomElement=grpArr[grpArr.indexOf(currentActiveElement)+1];
        if(nextDomElement==null) { 
            return false;
        }
        if( groupNo==Number.parseInt((nextDomElement.getAttribute('data-tabindex').split('group')[1]).split('-')[0])&& Number.parseInt(nextDomElement.getAttribute('data-tabindex').split('-')[1])<window.curInd){
            return true;
        }
        return false;

    }
    function checkLoopPrev(){
        let currentActiveElement=document.activeElement;

        groupNo= (currentActiveElement.getAttribute('data-tabindex').split('group')[1]);
        groupNo=Number.parseInt( groupNo.split('-')[0]);
        grpArr=document.querySelectorAll(`[data-tabindex^="group${groupNo}"]`);
        grpArr=Array.from(grpArr);
        window.curInd=Number.parseInt(currentActiveElement.getAttribute('data-tabindex').split('-')[1]);
        let prevDomElement=grpArr[grpArr.indexOf(currentActiveElement)-1];
        if(prevDomElement==null) {return false;}
        if( groupNo==Number.parseInt((prevDomElement.getAttribute('data-tabindex').split('group')[1]).split('-')[0])&& Number.parseInt(prevDomElement.getAttribute('data-tabindex').split('-')[1])>window.curInd){
            return true;
        }
        return false;
    }
    function changeFocus(groupNo){
        focArr.forEach(function(ele){
            if(ele.getAttribute('lyte-focus-after')){
                    let contArr=ele.getAttribute('lyte-focus-after').split(',');
                    if(contArr.includes(groupNo.toString())){
                        window.event.preventDefault();
                        ele.focus();
                    }
            }
        });
    }

    function isLastOfGroup( elem ){
        let ind = grpArr.indexOf( elem );
        
        return ind === grpArr.length-1;
    }

    function getCurInd( elem ){
        let curInd = Number.parseInt( elem.getAttribute('data-tabindex').split('-')[1] );

        return curInd;
    }

    function isSameIndExists( elem, curInd ){
        let ind = grpArr.indexOf( elem );

        for( window.i=ind+1; window.i<grpArr.length; window.i++ ){
            if( getCurInd( grpArr[window.i] ) == curInd ){
                return window.i;
            }
        }

        return -1;
    }

    function isSameIndExistsPrev( elem, curInd ){
        let ind = grpArr.indexOf( elem );

        for( window.i=ind-1; window.i>=0; window.i-- ){
            if( getCurInd( grpArr[window.i] ) == curInd ){
                return window.i;
            }
        }

        return -1;
    }
    
        
  }
  
  } );  
