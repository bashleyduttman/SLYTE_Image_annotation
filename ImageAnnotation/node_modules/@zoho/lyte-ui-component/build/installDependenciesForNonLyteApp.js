//ignorei18n_start
// Required Modules
const path = require('path');
const fs = require('fs');
const child_process = require('child_process');
const logger = require('./logger.js');
// Global Variables
const spawn = child_process.spawn;
const basePath = process.env.INIT_CWD;
const ZOHO_REGISTRY = 'ht' + 'tp://cm-npmregistry.csez.zohocorpin.com';
const GLOBAL_REGISTRY = 'ht' + 'tps://registry.npmjs.org';
const dependenciesToInstall = [];

var fn = function( dep, file ){
  var ns = "@zoho/"
     try{
          require.resolve( ns + file );
      } catch( e ){
         dependenciesToInstall.push( ns + dep );
      }
}

fn( 'lyte-cli@3.3.1', 'lyte-cli' );
fn( 'lyte@3.1.2', 'lyte/lyte-es5.js' );


const getCmdBasedOnOs = function (cmd) {
  switch (cmd) {
    case `npm`: {
      if (process.platform === `win32`) {
        return `npm.cmd`;
      }
    }
  }
  // for mac, ubuntu -> npm will work
  return cmd;
}

// Main Function
logger.info(`${basePath} : this is the basePath used in preinstall hook`)
const buildJsPath = path.join(basePath, `/build/build.js`);
const isBuildFileExists = fs.existsSync(buildJsPath);
if (isBuildFileExists || dependenciesToInstall.length == 0 ) {
  logger.highlight(`${buildJsPath} - Lyte Configuration File found. Skipping dependency installation process`);
} else {
  logger.highlight(`Found a Non-Lyte Application. Loading Dependencies, Please wait...`);

  const argsOfCommand = [].concat(`install`, dependenciesToInstall, `--registry ${ZOHO_REGISTRY}`,'--no-save');
  const rootCommand = getCmdBasedOnOs(`npm`);

  const instanceOfSpawn = spawn(rootCommand, argsOfCommand, { cwd: basePath });
  instanceOfSpawn.stdout.on(`data`, dataStream => logger.success(dataStream.toString()))
  instanceOfSpawn.stderr.on(`data`, errorStream => logger.error(errorStream.toString()))
}
//ignorei18n_end